name: Build and Release

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'Target Architecture'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - aarch64
          - android-aarch64

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      ALCC_TARGET_ARCH: ${{ inputs.target_arch || 'x86_64' }}

    steps:
    - uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        if [ "$ALCC_TARGET_ARCH" = "aarch64" ]; then
          sudo dpkg --add-architecture arm64

          # Handle Ubuntu 24.04+ (DEB822)
          if [ -f /etc/apt/sources.list.d/ubuntu.sources ]; then
            # Restrict all existing sources to amd64
            sudo sed -i '/^Types: deb/a Architectures: amd64' /etc/apt/sources.list.d/ubuntu.sources
          fi

          # Handle older Ubuntu (One-Line-Style)
          if [ -f /etc/apt/sources.list ]; then
             sudo sed -i 's/deb http/deb [arch=amd64] http/g' /etc/apt/sources.list
          fi

          # Add arm64 ports
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -sc) main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -sc)-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -sc)-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list

          sudo apt-get update
          sudo apt-get install -y g++-aarch64-linux-gnu gcc-aarch64-linux-gnu libc6-dev-arm64-cross libreadline-dev:arm64
        elif [ "$ALCC_TARGET_ARCH" = "android-aarch64" ]; then
          echo "Building for Android (Termux). Using NDK at $ANDROID_NDK_HOME"
          if [ -z "$ANDROID_NDK_HOME" ]; then
             echo "Error: ANDROID_NDK_HOME is not set."
             exit 1
          fi
        else
          sudo apt-get update
          sudo apt-get install -y libreadline-dev
        fi

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ runner.os }}-${{ env.ALCC_TARGET_ARCH }}

    - name: Cache Lua Source
      id: cache-lua
      uses: actions/cache@v3
      with:
        path: lua_source
        key: lua-source-v1-${{ runner.os }}-${{ env.ALCC_TARGET_ARCH }}

    - name: Setup Lua
      if: steps.cache-lua.outputs.cache-hit != 'true'
      run: |
        rm -rf lua_source
        git clone https://github.com/lua/lua.git lua_source
        cd lua_source
        if [ "$ALCC_TARGET_ARCH" = "aarch64" ]; then
           make linux CC="ccache aarch64-linux-gnu-gcc" AR="aarch64-linux-gnu-ar rcu" RANLIB=aarch64-linux-gnu-ranlib
        elif [ "$ALCC_TARGET_ARCH" = "android-aarch64" ]; then
           NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
           CC="$NDK_TOOLCHAIN/aarch64-linux-android24-clang"
           AR="$NDK_TOOLCHAIN/llvm-ar rcu"
           RANLIB="$NDK_TOOLCHAIN/llvm-ranlib"
           # Use posix to avoid readline, but enable dlopen and standard Lua libs
           make posix CC="ccache $CC" AR="$AR" RANLIB="$RANLIB" SYSCFLAGS="-DLUA_USE_LINUX" SYSLIBS="-Wl,-E -lm -ldl"
        else
           make all CC="ccache gcc"
        fi

    - name: Ensure Lua Built (if cached)
      if: steps.cache-lua.outputs.cache-hit == 'true'
      run: |
        cd lua_source
        if [ ! -f "liblua.a" ]; then
           if [ "$ALCC_TARGET_ARCH" = "aarch64" ]; then
             make linux CC="ccache aarch64-linux-gnu-gcc" AR="aarch64-linux-gnu-ar rcu" RANLIB=aarch64-linux-gnu-ranlib
           elif [ "$ALCC_TARGET_ARCH" = "android-aarch64" ]; then
             NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
             CC="$NDK_TOOLCHAIN/aarch64-linux-android24-clang"
             AR="$NDK_TOOLCHAIN/llvm-ar rcu"
             RANLIB="$NDK_TOOLCHAIN/llvm-ranlib"
             make posix CC="ccache $CC" AR="$AR" RANLIB="$RANLIB" SYSCFLAGS="-DLUA_USE_LINUX" SYSLIBS="-Wl,-E -lm -ldl"
           else
             make all CC="ccache gcc"
           fi
        fi

    - name: Build ALCC
      run: |
        cd ALCC
        if [ "$ALCC_TARGET_ARCH" = "aarch64" ]; then
           make CXX="ccache aarch64-linux-gnu-g++"
        elif [ "$ALCC_TARGET_ARCH" = "android-aarch64" ]; then
           NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
           CXX="$NDK_TOOLCHAIN/aarch64-linux-android24-clang++"
           make CXX="ccache $CXX"
        else
           make CXX="ccache g++"
        fi

    - name: Prepare Release Artifacts
      run: |
        mkdir -p release
        cp ALCC/alcc ALCC/alcc-c ALCC/alcc-d ALCC/alcc-a ALCC/alcc-dec release/
        tar -czvf alcc-linux-${{ env.ALCC_TARGET_ARCH }}.tar.gz -C release .

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: alcc-linux-${{ env.ALCC_TARGET_ARCH }}
        path: alcc-linux-${{ env.ALCC_TARGET_ARCH }}.tar.gz

    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: alcc-linux-${{ env.ALCC_TARGET_ARCH }}.tar.gz
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean ALCC Build
      run: |
        cd ALCC
        make clean
