name: Build and Release

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'Target Architecture'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - aarch64
          - android-aarch64
      lua_version:
        description: 'Lua Version'
        required: true
        default: '5.5'
        type: choice
        options:
          - '5.5'
          - '5.3'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      ALCC_TARGET_ARCH: ${{ inputs.target_arch || 'x86_64' }}
      LUA_VER: ${{ inputs.lua_version || '5.5' }}

    steps:
    - uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        if [ "$ALCC_TARGET_ARCH" = "aarch64" ]; then
          sudo dpkg --add-architecture arm64

          # Handle Ubuntu 24.04+ (DEB822)
          if [ -f /etc/apt/sources.list.d/ubuntu.sources ]; then
            # Restrict all existing sources to amd64
            sudo sed -i '/^Types: deb/a Architectures: amd64' /etc/apt/sources.list.d/ubuntu.sources
          fi

          # Handle older Ubuntu (One-Line-Style)
          if [ -f /etc/apt/sources.list ]; then
             sudo sed -i 's/deb http/deb [arch=amd64] http/g' /etc/apt/sources.list
          fi

          # Add arm64 ports
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -sc) main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -sc)-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -sc)-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list

          sudo apt-get update
          sudo apt-get install -y g++-aarch64-linux-gnu gcc-aarch64-linux-gnu libc6-dev-arm64-cross libreadline-dev:arm64
        elif [ "$ALCC_TARGET_ARCH" = "android-aarch64" ]; then
          echo "Building for Android (Termux). Using NDK at $ANDROID_NDK_HOME"
          if [ -z "$ANDROID_NDK_HOME" ]; then
             echo "Error: ANDROID_NDK_HOME is not set."
             exit 1
          fi
        else
          sudo apt-get update
          sudo apt-get install -y libreadline-dev
        fi

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ runner.os }}-${{ env.ALCC_TARGET_ARCH }}

    - name: Cache Lua Source
      id: cache-lua
      uses: actions/cache@v3
      with:
        path: |
          lua_source
          lua53_source
        key: lua-source-v2-${{ runner.os }}-${{ env.ALCC_TARGET_ARCH }}-${{ env.LUA_VER }}

    - name: Setup Lua
      if: steps.cache-lua.outputs.cache-hit != 'true'
      run: |
        LUA_SRC_DIR="lua_source"
        if [ "$LUA_VER" = "5.3" ]; then
           LUA_SRC_DIR="lua53_source"
           rm -rf $LUA_SRC_DIR
           git clone https://github.com/lua/lua.git $LUA_SRC_DIR
           cd $LUA_SRC_DIR
           git checkout v5.3.6
        else
           rm -rf $LUA_SRC_DIR
           git clone https://github.com/lua/lua.git $LUA_SRC_DIR
           cd $LUA_SRC_DIR
        fi

        sed -i 's/-march=native//g' makefile
        LUA_MAKE_TARGET="all"

        if [ "$ALCC_TARGET_ARCH" = "aarch64" ]; then
           make $LUA_MAKE_TARGET CC="ccache aarch64-linux-gnu-gcc" AR="aarch64-linux-gnu-ar rcu" RANLIB=aarch64-linux-gnu-ranlib
        elif [ "$ALCC_TARGET_ARCH" = "android-aarch64" ]; then
           NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
           CC="$NDK_TOOLCHAIN/aarch64-linux-android24-clang"
           AR="$NDK_TOOLCHAIN/llvm-ar rcu"
           RANLIB="$NDK_TOOLCHAIN/llvm-ranlib"
           # Use posix to avoid readline for Android
           if [ "$LUA_VER" = "5.3" ]; then
              make $LUA_MAKE_TARGET CC="ccache $CC" AR="$AR" RANLIB="$RANLIB" MYCFLAGS="-std=c99 -DLUA_USE_POSIX -DLUA_COMPAT_5_2" MYLIBS=""
           else
              make $LUA_MAKE_TARGET CC="ccache $CC" AR="$AR" RANLIB="$RANLIB"
           fi
        else
           make $LUA_MAKE_TARGET CC="ccache gcc"
        fi

    - name: Ensure Lua Built (if cached)
      if: steps.cache-lua.outputs.cache-hit == 'true'
      run: |
        LUA_SRC_DIR="lua_source"
        LUA_MAKE_TARGET="all"
        if [ "$LUA_VER" = "5.3" ]; then
           LUA_SRC_DIR="lua53_source"
        fi
        cd $LUA_SRC_DIR

        sed -i 's/-march=native//g' makefile
        if [ ! -f "liblua.a" ]; then
           if [ "$ALCC_TARGET_ARCH" = "aarch64" ]; then
             make $LUA_MAKE_TARGET CC="ccache aarch64-linux-gnu-gcc" AR="aarch64-linux-gnu-ar rcu" RANLIB=aarch64-linux-gnu-ranlib
           elif [ "$ALCC_TARGET_ARCH" = "android-aarch64" ]; then
             NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
             CC="$NDK_TOOLCHAIN/aarch64-linux-android24-clang"
             AR="$NDK_TOOLCHAIN/llvm-ar rcu"
             RANLIB="$NDK_TOOLCHAIN/llvm-ranlib"
             if [ "$LUA_VER" = "5.3" ]; then
                make $LUA_MAKE_TARGET CC="ccache $CC" AR="$AR" RANLIB="$RANLIB" MYCFLAGS="-std=c99 -DLUA_USE_POSIX -DLUA_COMPAT_5_2" MYLIBS=""
             else
                make $LUA_MAKE_TARGET CC="ccache $CC" AR="$AR" RANLIB="$RANLIB"
             fi
           else
             make $LUA_MAKE_TARGET CC="ccache gcc"
           fi
        fi

    - name: Build ALCC
      run: |
        cd ALCC
        if [ "$ALCC_TARGET_ARCH" = "aarch64" ]; then
           make CXX="ccache aarch64-linux-gnu-g++" LUA_VER=${{ env.LUA_VER }}
        elif [ "$ALCC_TARGET_ARCH" = "android-aarch64" ]; then
           NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
           CXX="$NDK_TOOLCHAIN/aarch64-linux-android24-clang++"
           make CXX="ccache $CXX" LUA_VER=${{ env.LUA_VER }} NO_READLINE=1
        else
           make CXX="ccache g++" LUA_VER=${{ env.LUA_VER }}
        fi

    - name: Prepare Release Artifacts
      run: |
        mkdir -p release
        SUFFIX=""
        if [ "$LUA_VER" = "5.3" ]; then SUFFIX="-5.3"; fi
        cp ALCC/alcc$SUFFIX ALCC/alcc-c$SUFFIX ALCC/alcc-d$SUFFIX ALCC/alcc-a$SUFFIX ALCC/alcc-dec$SUFFIX release/
        tar -czvf alcc-linux-${{ env.ALCC_TARGET_ARCH }}$SUFFIX.tar.gz -C release .

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: alcc-linux-${{ env.ALCC_TARGET_ARCH }}${{ env.LUA_VER == '5.3' && '-5.3' || '' }}
        path: alcc-linux-${{ env.ALCC_TARGET_ARCH }}${{ env.LUA_VER == '5.3' && '-5.3' || '' }}.tar.gz

    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: alcc-linux-${{ env.ALCC_TARGET_ARCH }}${{ env.LUA_VER == '5.3' && '-5.3' || '' }}.tar.gz
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean ALCC Build
      run: |
        cd ALCC
        make clean
